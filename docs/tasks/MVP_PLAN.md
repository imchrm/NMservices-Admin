# Глобальный план работ: Этап MVP

## Обзор

**Цель MVP:** Реализовать минимальный функционал для приёма заказов на услуги массажа через Telegram-бот с управлением через Admin Panel.

**Компоненты системы:**
| Компонент | Технологии | Путь |
|-----------|------------|------|
| Backend (микросервисы) | Python, FastAPI, uvicorn | `C:\Users\zum\dev\python\NMservices` |
| Frontend (Telegram-бот) | Python, aiogram | `C:\Users\zum\dev\python\NMservices` |
| Frontend (Admin Panel) | TypeScript, React, react-admin, Vite | `C:\Users\zum\dev\js\NMservices-Admin` |
| База данных | PostgreSQL | nomus |

**Текущий статус:** Задача 1 (Backend) завершена и верифицирована (2026-02-10)

---

## План работ

### Задача 1: Backend — Каталог услуг и расширение заказов ✅ ЗАВЕРШЕНА

**Описание:** Реализация функционала согласно `docs/tasks/MVP_services_table.md`

**Подзадачи:**
- [x] 1.1. Миграция: создание таблицы `services`
- [x] 1.2. Миграция: расширение таблицы `orders` (service_id, address_text, scheduled_at)
- [x] 1.3. SQLAlchemy модели (Service, обновление Order)
- [x] 1.4. Pydantic модели (ServiceResponse, ServiceCreateRequest, обновление OrderCreateRequest)
- [x] 1.5. API endpoints для услуг (CRUD)
- [x] 1.6. Обновление API endpoints для заказов
- [x] 1.7. Seed данные (базовые услуги)
- [x] 1.8. Обновление CLI утилиты (управление услугами)
- [x] 1.9. Тесты для новых endpoints (30/30 passed)
- [x] 1.10. Обновление документации

**Верификация (2026-02-10):**
- [x] Миграция БД на dm@id (3 миграции)
- [x] Структура БД через psql (7/7 проверок)
- [x] db_cli.py — услуги и заказы работают
- [x] pytest — 30/30 passed
- [x] API: GET /services, GET /services/1, POST /orders с service_id

**Критерии завершения:** см. `docs/tasks/MVP_services_table.md` → Критерии приёмки

---

### Задача 2: Admin Panel — Полная (услуги + заказы + пользователи)

**Описание:** Единая Admin Panel для управления всеми сущностями системы. Объединяет бывшие задачи 4, 5, 6.

**Стек:** TypeScript, React, react-admin, Vite
**Репозиторий:** `NMservices-Admin`

**Подзадачи:**

#### 2.1. Инициализация проекта
- [ ] 2.1.1. Создать проект (Vite + React + TypeScript)
- [ ] 2.1.2. Установить react-admin и зависимости
- [ ] 2.1.3. Настроить dataProvider для подключения к API (http://192.168.1.191:8000)
- [ ] 2.1.4. Настроить authProvider (X-Admin-Key)

#### 2.2. Dashboard
- [ ] 2.2.1. Статистика: кол-во пользователей, заказов, услуг
- [ ] 2.2.2. Заказы по статусам (pending/confirmed/in_progress/completed/cancelled)

#### 2.3. Услуги (services)
- [ ] 2.3.1. Список услуг (таблица с фильтрацией и сортировкой)
- [ ] 2.3.2. Просмотр услуги (детальная карточка)
- [ ] 2.3.3. Создание услуги (форма)
- [ ] 2.3.4. Редактирование услуги
- [ ] 2.3.5. Деактивация услуги (soft delete)

#### 2.4. Заказы (orders)
- [ ] 2.4.1. Список заказов (таблица с фильтрацией по статусу, дате)
- [ ] 2.4.2. Просмотр заказа (детали: пользователь, услуга, адрес, статус)
- [ ] 2.4.3. Редактирование заказа (смена статуса, notes)
- [ ] 2.4.4. Создание заказа (ручное создание администратором)

#### 2.5. Пользователи (users)
- [ ] 2.5.1. Список пользователей (таблица)
- [ ] 2.5.2. Просмотр пользователя (профиль + история заказов)

**Критерии завершения:**
- Администратор может управлять услугами (CRUD + деактивация)
- Администратор может управлять заказами (список, статус, детали)
- Администратор может просматривать пользователей с историей заказов
- Dashboard показывает актуальную статистику

---

### Задача 3: Telegram-бот — Флоу создания заказа

**Описание:** Реализация пользовательского сценария заказа услуги

**Подзадачи:**
- [ ] 3.1. Интеграция с API услуг (получение списка активных услуг)
- [ ] 3.2. Экран выбора услуги (inline-кнопки или меню)
- [ ] 3.3. Ввод адреса (текстовое сообщение)
- [ ] 3.4. Подтверждение заказа (summary + кнопки Подтвердить/Отмена)
- [ ] 3.5. Отправка заказа в API
- [ ] 3.6. Сообщение об успешном создании заказа
- [ ] 3.7. Обработка ошибок (услуга не найдена, API недоступен)

**User flow:**
```
/start или кнопка "Заказать"
    → Список услуг (название + цена + длительность)
    → Выбор услуги
    → "Введите адрес"
    → Ввод адреса
    → "Ваш заказ: [услуга], [адрес], [цена]. Подтвердить?"
    → [Подтвердить] / [Отмена]
    → "Заказ #123 создан! Мы свяжемся с вами."
```

**Критерии завершения:**
- Пользователь может выбрать услугу из каталога
- Пользователь может указать адрес
- Заказ сохраняется в БД через API
- Пользователь получает подтверждение

---

### Задача 4: Telegram-бот — Уведомления о статусе заказа

**Описание:** Пользователь получает сообщение при изменении статуса заказа

**Подзадачи:**
- [ ] 4.1. Webhook/polling endpoint для получения событий об изменении статуса
- [ ] 4.2. Сервис отправки уведомлений по telegram_id
- [ ] 4.3. Шаблоны сообщений для разных статусов
- [ ] 4.4. Обработка случая, когда пользователь заблокировал бота

**Статусы заказа (примерные):**
- `pending` → "Заказ принят"
- `confirmed` → "Заказ подтверждён, мастер выезжает"
- `in_progress` → "Мастер на месте"
- `completed` → "Заказ выполнен. Спасибо!"
- `cancelled` → "Заказ отменён"

**Критерии завершения:**
- При смене статуса заказа пользователь получает сообщение в Telegram

---

### Задача 5: Интеграция и тестирование

**Описание:** Проверка работы всей системы целиком

**Подзадачи:**
- [ ] 5.1. E2E тест: создание заказа через бот → отображение в Admin Panel
- [ ] 5.2. E2E тест: смена статуса в Admin Panel → уведомление в Telegram
- [ ] 5.3. Проверка работы при ошибках (API down, невалидные данные)
- [ ] 5.4. Документирование API (OpenAPI/Swagger актуален)

**Критерии завершения:**
- Полный цикл заказа работает
- Система устойчива к ошибкам

---

## Зависимости между задачами

```
Задача 1 (Backend) ✅
    ├── Задача 2 (Admin Panel) — требует API услуг, заказов, пользователей
    ├── Задача 3 (Бот: флоу заказа) — требует API услуг и заказов
    └── Задача 4 (Бот: уведомления) — требует механизм смены статуса (Admin Panel)

Задача 5 (Интеграция) — после всех остальных задач
```

**Порядок выполнения:**
1. **Задача 1** — Backend ✅ ЗАВЕРШЕНА
2. **Задача 2** — Admin Panel (управление услугами, заказами, пользователями)
3. **Задача 3** — Telegram-бот: флоу заказа
4. **Задача 4** — Telegram-бот: уведомления о статусе
5. **Задача 5** — Финальная интеграция и тестирование

---

## Оценка объёма

| Задача | Компонент | Сложность | Статус |
|--------|-----------|-----------|--------|
| 1 | Backend | Средняя | ✅ Завершена |
| 2 | Admin Panel (полная) | Средняя | Следующая |
| 3 | Telegram-бот (заказ) | Средняя | Ожидает |
| 4 | Telegram-бот (уведомления) | Низкая | Ожидает |
| 5 | Интеграция | Низкая | Ожидает |

---

## Риски

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Изменение требований | Средняя | Гибкая архитектура, MVP подход |
| Проблемы с Telegram API | Низкая | Rate limiting, retry логика |
| Несовместимость версий | Низкая | Фиксация версий зависимостей |

---

## Связанные документы

- [MVP Services Table](./MVP_services_table.md) — детальное ТЗ для Задачи 1
- [TODO: Pydantic v2 ConfigDict](./TODO_pydantic_v2_config.md) — мелкий рефакторинг admin.py
- `docs/development/database-schema-mvp.md` — схема БД
- `docs/session-context-mvp-services.md` — контекст сессии lucid-beaver

---

## История изменений

| Дата | Версия | Описание |
|------|--------|----------|
| 2025-02-03 | 1.0 | Создание плана |
| 2026-02-10 | 2.0 | Задача 1 завершена. Реорганизация: Admin Panel (задачи 4+5+6) → Задача 2, Telegram-бот → Задачи 3-4 |
